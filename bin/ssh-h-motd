#!/bin/sh -e
##:
#h: Usage: ssh-h-motd { -V | [-e EXTRA][-c COMMAND][-p PS1] SSH,... }
#h:
#h: Update the ~/.motd file in remote machines by consulting the
#h: $SSH_H_MOTD_DIRECTORY/SSH files. It will edit ~/.profile properly
#h: so that the message is displayed properly.
#h:
#h: You can add an extra text below the MOTD with -e. The message can
#h: be processed with COMMAND. You can set PS1 with -p.
##:
ssh_h_motd() {
    local OPTIND optopt opt_e= opt_c= opt_p= ml m msg tmp="$(mktemp -d)"
    
    ## Parse command line arguments.
    while getopts "e:c:p:" optopt; do
        case $optopt in
            e)  opt_e="${OPTARG}";;
            c)  opt_c="${OPTARG}";;
            p)  opt_p="${OPTARG}";;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))
    
    ## Calculate machine list.
    if which ssh-h-list >/dev/null 2>&1; then
        ml="$(ssh-h-list "$@")"
    else
        ml="$(echo "$*" | tr ',' ' ')"
    fi
    
    ## For each specified machine.
    for m in ${ml}; do
        echo "== ${m}"
        msg=""
        if test -f "${SSH_H_MOTD_DIRECTORY}/${m}"; then
            msg="$(cat "${SSH_H_MOTD_DIRECTORY}/${m}")"
        fi
        if test -n "${opt_e}"; then
            msg="${msg:+${msg}${NL}}${opt_e}"
        fi
        if test -n "${opt_c}"; then
            msg="$(echo "${msg}" | eval "${opt_c}")"
        fi
        cat > "${tmp}/.motd" <<-EOF
	${msg}
	EOF
        cat > "${tmp}/.profile.motd" <<-EOF
	${opt_p:+export PS1='${opt_p}'}
	case "\$-" in *i*) cat ~/.motd;; esac
	EOF
        scp "${tmp}/.motd" "${tmp}/.profile.motd" "$m":"."
        ssh "$m" "
            if test -f ~/.profile; then
                echo 'Editing ~/.profile.motd ...'
                sed -i '\\|/.profile.motd|d' ~/.profile
                echo '. ~/.profile.motd' >> ~/.profile
            fi
        "
    done
        
    
}
## -------------------------------------------------------------------
SSH_H_MOTD_DIRECTORY="${SSH_H_MOTD_DIRECTORY:-${HOME}/.motd.d}"
NL="
"
if test @"${SCRNAME:-$(basename "$0")}" = @"ssh-h-motd"; then
    case "${1}" in
        ''|-h|--help) sed -n 's/^ *#h: \{0,1\}//p' "$0";;
        -*V*) echo "SSH_H_MOTD_DIRECTORY : ${SSH_H_MOTD_DIRECTORY}"; exit 0;;
        *)    ssh_h_motd "$@"; exit 0;;
    esac
fi
